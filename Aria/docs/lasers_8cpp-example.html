<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Aria: lasers.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lasers.cpp</h1>example showing how to connect to laser rangefinders attached to the robot and retrieve data from them. What kinds of laser or lasers are connected to the robot, and their parameters, are loaded from the robot's parameter file in the params directory. First the default for this type of mobile robot is loaded (e.g. p3dx-sh.p for a Pioneer 3 DX), followed by a parameter file specific to this individual robot (based on its 'name'), if such a parameter file exists. Laser parameters may also be given as command line options, use the -help option to list them. This program will only connect to any lasers that have LaserAutoConnect true in the parameter file, or if the -connectLaser or -cl command-line options are given. You may need to edit the parameter file for your robot to set LaserAutoConnect to true.<p>
TODO: show how to force laser connect even if autoconnect is false.<p>
This program will work either with the MobileSim simulator or on a real robot's onboard computer. (Or use -remoteHost to connect to a wireless ethernet-serial bridge.)<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "Aria.h"</span>

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
  <a name="a0"></a><a class="code" href="classAria.html#d99c16b5d947229d9f8e1c5b2d4cdd73" title="Initialize Aria global data struture and perform OS-specific initialization, including...">Aria::init</a>();
  <a name="a1"></a><a class="code" href="classArLog.html#74fa320b89ec1ece70053722c91f7c71" title="Initialize the logging utility with options.">ArLog::init</a>(<a name="a2"></a><a class="code" href="classArLog.html#a62617e816d9caa5853bf4ce9b34ca10cc775da407aa66d7ad368b9d1f80b70c" title="Use stderr for logging.">ArLog::StdErr</a>, <a name="a3"></a><a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce36e80d09c67dad73e9ba736e91ec893be" title="Use verbose logging.">ArLog::Verbose</a>);
  <a name="_a4"></a><a class="code" href="classArRobot.html" title="Central class for communicating with and operating the robot.">ArRobot</a> robot;
  <a name="_a5"></a><a class="code" href="classArArgumentParser.html" title="Class for parsing arguments.">ArArgumentParser</a> parser(&amp;argc, argv);
  parser.<a name="a6"></a><a class="code" href="classArArgumentParser.html#501694b62a7f8b0c3cadd84aeafe1b35" title="Adds args from default files and environmental variables.">loadDefaultArguments</a>();

  <a name="_a7"></a><a class="code" href="classArRobotConnector.html">ArRobotConnector</a> robotConnector(&amp;parser, &amp;robot);
  <a name="_a8"></a><a class="code" href="classArLaserConnector.html" title="Connect to robot and laser based on run-time availablitily and command-line arguments...">ArLaserConnector</a> laserConnector(&amp;parser, &amp;robot, &amp;robotConnector);

  <span class="comment">// Connect to the robot, get some initial data from it such as type and name,</span>
  <span class="comment">// and then load parameter files for this robot.</span>
  <span class="keywordflow">if</span>(!robotConnector.<a name="a9"></a><a class="code" href="classArRobotConnector.html#b192ac393d9cc1e5b61b1a82b08d085d" title="Sets up the robot then connects it.">connectRobot</a>())
  {
    <a name="a10"></a><a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a name="a11"></a><a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce3012daf6573594f91242f8dd7c02eb74b" title="Use terse logging.">ArLog::Terse</a>, <span class="stringliteral">"lasersExample: Could not connect to the robot."</span>);
    <span class="keywordflow">if</span>(parser.<a name="a12"></a><a class="code" href="classArArgumentParser.html#c3889cbdfa862031c51bf80e06954914" title="Checks for the help strings and warns about unparsed arguments.">checkHelpAndWarnUnparsed</a>())
    {
        <span class="comment">// -help not given</span>
        <a name="a13"></a><a class="code" href="classAria.html#10d71f3d4d0cf7f38c58a1f749f64a42" title="Logs all the options for the program (Calls all the callbacks added with addLogOptionsCB())...">Aria::logOptions</a>();
        <a name="a14"></a><a class="code" href="classAria.html#6abc3d39b3e9548063bb8e78375acc17" title="Shutdown all Aria processes/threads, call exit callbacks, and exit the program.">Aria::exit</a>(1);
    }
  }


  <span class="keywordflow">if</span> (!<a name="a15"></a><a class="code" href="classAria.html#1b090c01d88bb420b8cf8e0384d25ee1" title="Parses the arguments for the program (calls all the callbacks added with addParseArgsCB())...">Aria::parseArgs</a>())
  {
    <a class="code" href="classAria.html#10d71f3d4d0cf7f38c58a1f749f64a42" title="Logs all the options for the program (Calls all the callbacks added with addLogOptionsCB())...">Aria::logOptions</a>();
    <a class="code" href="classAria.html#6abc3d39b3e9548063bb8e78375acc17" title="Shutdown all Aria processes/threads, call exit callbacks, and exit the program.">Aria::exit</a>(2);
    <span class="keywordflow">return</span> 2;
  }
  
  <a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a name="a16"></a><a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1" title="Use normal logging.">ArLog::Normal</a>, <span class="stringliteral">"lasersExample: Connected to robot."</span>);

  <span class="comment">// Start the robot processing cycle running in the background.</span>
  <span class="comment">// True parameter means that if the connection is lost, then the </span>
  <span class="comment">// run loop ends.</span>
  robot.<a name="a17"></a><a class="code" href="classArRobot.html#79199f70fee00e4e4a66452d1bbea19b" title="Starts the instance to do processing in its own new thread.">runAsync</a>(<span class="keyword">true</span>);


  <span class="comment">// Connect to laser(s) as defined in parameter files.</span>
  <span class="comment">// (Some flags are available as arguments to connectLasers() to control error behavior and to control which lasers are put in the list of lasers stored by ArRobot. See docs for details.)</span>
  <span class="keywordflow">if</span>(!laserConnector.<a name="a18"></a><a class="code" href="classArLaserConnector.html#4055a788584ae0bef664563e9b7864c8" title="Connects all the lasers the robot has that should be auto connected.">connectLasers</a>())
  {
    <a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce3012daf6573594f91242f8dd7c02eb74b" title="Use terse logging.">ArLog::Terse</a>, <span class="stringliteral">"Could not connect to configured lasers. Exiting."</span>);
    <a class="code" href="classAria.html#6abc3d39b3e9548063bb8e78375acc17" title="Shutdown all Aria processes/threads, call exit callbacks, and exit the program.">Aria::exit</a>(3);
    <span class="keywordflow">return</span> 3;
  }

  <span class="comment">// Allow some time to read laser data</span>
  <a name="a19"></a><a class="code" href="classArUtil.html#4dfb878a3f9123b8dd96ae05b2fd94cb" title="Sleep for the given number of milliseconds.">ArUtil::sleep</a>(500);

  <a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1" title="Use normal logging.">ArLog::Normal</a>, <span class="stringliteral">"Connected to all lasers."</span>);

  <span class="comment">// Print out some data from each connected laser.</span>
  <span class="keywordflow">while</span>(robot.<a name="a20"></a><a class="code" href="classArRobot.html#98b5d608fb9f33aec47a3fe1995dc5b6" title="Questions whether the robot is connected or not.">isConnected</a>())
  {
    <span class="keywordtype">int</span> numLasers = 0;

      <span class="comment">// Get a pointer to ArRobot's list of connected lasers. We will lock the robot while using it to prevent changes by tasks in the robot's background task thread or any other threads. Each laser has an index. You can also store the laser's index or name (laser-&gt;getName()) and use that to get a reference (pointer) to the laser object using ArRobot::findLaser().</span>
      robot.<a name="a21"></a><a class="code" href="classArRobot.html#5aecc7ac998c9a31b82fdb904efa8609" title="Lock the robot instance.">lock</a>();
      std::map&lt;int, ArLaser*&gt; *lasers = robot.<a name="a22"></a><a class="code" href="classArRobot.html#62ad0a5f2cc0973f08f8d85bea1d5d7b" title="Gets the range device list.">getLaserMap</a>();

      <span class="keywordflow">for</span>(std::map&lt;int, ArLaser*&gt;::const_iterator i = lasers-&gt;begin(); i != lasers-&gt;end(); ++i)
      {
        <span class="keywordtype">int</span> laserIndex = (*i).first;
        <a name="_a23"></a><a class="code" href="classArLaser.html">ArLaser</a>* laser = (*i).second;
        <span class="keywordflow">if</span>(!laser)
            <span class="keywordflow">continue</span>;
        ++numLasers;
        laser-&gt;<a name="a24"></a><a class="code" href="classArRangeDeviceThreaded.html#40460f97ba63b21ea12f61368df8caa9">lockDevice</a>();

        <span class="comment">// The current readings are a set of obstacle readings (with X,Y positions as well as other attributes) that are the most recent set from teh laser.</span>
        std::list&lt;ArPoseWithTime*&gt; *currentReadings = laser-&gt;<a name="a25"></a><a class="code" href="classArRangeDevice.html#072ac84980687ed353b3e5c2e36d6d68" title="Gets the current buffer of readings.">getCurrentBuffer</a>(); <span class="comment">// see ArRangeDevice interface doc</span>

        <span class="comment">// There is a utility to find the closest reading wthin a range of degrees around the laser, here we use this laser's full field of view (start to end)</span>
        <span class="comment">// If there are no valid closest readings within the given range, dist will be greater than laser-&gt;getMaxRange().</span>
        <span class="keywordtype">double</span> angle = 0;
        <span class="keywordtype">double</span> dist = laser-&gt;<a name="a26"></a><a class="code" href="classArRangeDevice.html#27b080d64bdedd8f593ffcc6c373d609" title="Gets the closest current reading in the given polar region.">currentReadingPolar</a>(laser-&gt;<a name="a27"></a><a class="code" href="classArLaser.html#c589039384c421703756eac2861899bf" title="Gets the start angle.">getStartDegrees</a>(), laser-&gt;<a name="a28"></a><a class="code" href="classArLaser.html#a6aa3c7373dc933b8f32bb36c23cd088" title="Gets the end angle.">getEndDegrees</a>(), &amp;angle);

        <a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1" title="Use normal logging.">ArLog::Normal</a>, <span class="stringliteral">"Laser #%d (%s): %s. Have %d 'current' readings. Closest reading is at %3.0f degrees and is %2.4f meters away."</span>, laserIndex, laser-&gt;<a name="a29"></a><a class="code" href="classArRangeDevice.html#df76b644d209c28628a1f7ba4047b60b" title="Gets the name of the device.">getName</a>(), (laser-&gt;<a name="a30"></a><a class="code" href="classArLaser.html#ae5c36df5b59ad861debb895e255479b" title="See if the laser is connected.">isConnected</a>() ? <span class="stringliteral">"connected"</span> : <span class="stringliteral">"NOT CONNECTED"</span>), currentReadings-&gt;size(), angle, dist/1000.0);
                laser-&gt;<a name="a31"></a><a class="code" href="classArRangeDeviceThreaded.html#74a529d4e24394c15877c541166d1b80">unlockDevice</a>();
        }
    <span class="keywordflow">if</span>(numLasers == 0)
        <a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1" title="Use normal logging.">ArLog::Normal</a>, <span class="stringliteral">"No lasers."</span>);
    <span class="keywordflow">else</span>
        <a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1" title="Use normal logging.">ArLog::Normal</a>, <span class="stringliteral">""</span>);

        <span class="comment">// Unlock robot and sleep for 5 seconds before next loop.</span>
    robot.<a name="a32"></a><a class="code" href="classArRobot.html#403d9de010dc2b8d478cd0b14b2d9491" title="Unlock the robot instance.">unlock</a>();
    <a class="code" href="classArUtil.html#4dfb878a3f9123b8dd96ae05b2fd94cb" title="Sleep for the given number of milliseconds.">ArUtil::sleep</a>(5000);
   }

  <a class="code" href="classArLog.html#43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a class="code" href="classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1" title="Use normal logging.">ArLog::Normal</a>, <span class="stringliteral">"lasersExample: exiting."</span>);
  <a class="code" href="classAria.html#6abc3d39b3e9548063bb8e78375acc17" title="Shutdown all Aria processes/threads, call exit callbacks, and exit the program.">Aria::exit</a>(0);
  <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Aug 1 12:22:50 2012 for Aria by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
