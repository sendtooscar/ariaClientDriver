<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ArNetworking: getVideoExample.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>getVideoExample.cpp</h1>This example client requests video images from the server and saves them repeatedly to a file named "video.jpg", or to a series of files ("video1.jpg", "video2.jpg", etc.) if you give the -counter option. Give the image request rate in images per second with the -rate option (or use -1 to let the server decide when to send image; may not work with all servers).<p>
Connect to SAVserver, ACTS, or another video server to get images.<p>
To make a movie from the images, you can use ffmpeg on Linux. First run with frame rate and counter options to save multiple images: ./getVideoExample -host robothost -port 7272 -rate 20 -counter Then use ffmpeg: ffmpeg -i videod.jpeg -r 20 movie.mpeg See ffmpeg -h for full list of options.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "Aria.h"</span>
<span class="preprocessor">#include "<a class="code" href="ArNetworking_8h.html">ArNetworking.h</a>"</span>

<span class="keywordtype">bool</span> <a name="a0"></a><a class="code" href="getVideoExample_8cpp.html#b2fdc0f1bbbd46b714580926f62fae6e">useCounter</a> = <span class="keyword">false</span>;
<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a name="a1"></a><a class="code" href="getVideoExample_8cpp.html#2c605870a4e5975004e2e04a9a033d35">counter</a> = 1;

<span class="keywordtype">double</span> <a name="a2"></a><a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a> = 0;
<span class="keywordtype">int</span> <a name="a3"></a><a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a> = 0;

<span class="keywordtype">void</span> <a name="a4"></a><a class="code" href="getVideoExample_8cpp.html#b990e842f67b35df051fd7edddd35888">jpegHandler</a>(<a name="_a5"></a><a class="code" href="classArNetPacket.html" title="our packet for the network stuff">ArNetPacket</a> *packet)
{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height;
  <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> jpeg[50000];
  <span class="keywordtype">int</span> jpegSize;
  FILE *<a name="a6"></a><a class="code" href="configClientToServer_8cpp.html#df16cd437526a5c5e0e0af87745acbb8">file</a>;

  width = packet-&gt;<a name="a7"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#c2d63293b9a983d18430eceb0edbf0b1">bufToUByte2</a>();
  height = packet-&gt;<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#c2d63293b9a983d18430eceb0edbf0b1">bufToUByte2</a>();
  jpegSize = packet-&gt;<a name="a8"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#01358dab3ea8fff1944c4dfe18d2fa18">getDataLength</a>() - packet-&gt;<a name="a9"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#4d6b19f14278ec27d4208503c0b5c167">getDataReadLength</a>();
  <span class="keywordflow">if</span>(jpegSize &gt; 50000)
  {
    <a name="a10"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a name="a11"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Cannot save image, it's too big. (image is %d bytes, my buffer is 50000 bytes)"</span>, jpegSize);
    <span class="keywordflow">return</span>;
  }
  packet-&gt;<a name="a12"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArBasePacket.html#885a0bdc2036056abadd3a3eafe4bdeb">bufToData</a>((<span class="keywordtype">char</span> *)jpeg, jpegSize);
  <span class="keywordtype">char</span> filename[128];
  <span class="keywordtype">char</span> tmpFilename[128];
  sprintf(tmpFilename, <span class="stringliteral">"tmp.jpg"</span>);
  <span class="keywordflow">if</span> ((file = <a name="a13"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArUtil.html#0c4d240777628983e66005d7f7a4939c">ArUtil::fopen</a>(tmpFilename, <span class="stringliteral">"wb"</span>)) != NULL)
  {
    fwrite(jpeg, jpegSize, 1, file);
    fclose(file);
    <span class="keywordflow">if</span>(<a class="code" href="getVideoExample_8cpp.html#b2fdc0f1bbbd46b714580926f62fae6e">useCounter</a>)
      snprintf(filename, 64, <span class="stringliteral">"video%lu.jpg"</span>, <a class="code" href="getVideoExample_8cpp.html#2c605870a4e5975004e2e04a9a033d35">counter</a>++);
    <span class="keywordflow">else</span>
      strcpy(filename, <span class="stringliteral">"video.jpg"</span>);
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    <span class="comment">// On windows, rename() fails if the new file already exists</span>
    unlink(filename);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (rename(tmpFilename, filename) == 0)
      <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Wrote a %dx%d image, %d bytes, named %s."</span>, width, height, jpegSize, filename);
    <span class="keywordflow">else</span>
      <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Wrote a %dx%d image, %d bytes, named %s (could not rename to real name)."</span>, width, height, jpegSize, tmpFilename);
  }
  <span class="keywordflow">else</span>
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Could not write temp file %s"</span>, tmpFilename);

  <span class="keywordflow">if</span> (<a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a> == 0 || <a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a> == 0)
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Only one frame was requested, so exiting"</span>);
    <a name="a14"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#6abc3d39b3e9548063bb8e78375acc17">Aria::exit</a>(0);
  }
}

<span class="keywordtype">int</span> <a name="a15"></a><a class="code" href="clientCommandLister_8cpp.html#3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{

<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>  <a name="_a16"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArDaemonizer.html">ArDaemonizer</a> daemonizer(&amp;argc, argv, <span class="keyword">false</span>);
  <span class="keywordtype">bool</span> isDaemonized = <span class="keyword">false</span>;
  <span class="keywordflow">if</span> (!daemonizer.daemonize())
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a name="a17"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce3012daf6573594f91242f8dd7c02eb74b">ArLog::Terse</a>, <span class="stringliteral">"Could not daemonize process"</span>);
    exit(1);
  }
  <span class="keywordflow">if</span> (daemonizer.isDaemonized())
    isDaemonized = <span class="keyword">true</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <a name="a18"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#d99c16b5d947229d9f8e1c5b2d4cdd73">Aria::init</a>();
  <a name="a19"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#74fa320b89ec1ece70053722c91f7c71">ArLog::init</a>(<a name="a20"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#a62617e816d9caa5853bf4ce9b34ca1035b2c9a3d5c6bb0f2dbe2064cc0163db">ArLog::File</a>, <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"getVideoLog.txt"</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>);
  
  <a name="_a21"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArArgumentParser.html">ArArgumentParser</a> argParser(&amp;argc, argv);
  argParser.loadDefaultArguments();

  <a name="_a22"></a><a class="code" href="classArClientSimpleConnector.html" title="This will let you connect to different hosts, ports, and with different users and...">ArClientSimpleConnector</a> clientConnector(&amp;argParser);

  <span class="keywordflow">if</span>(argParser.checkParameterArgumentDouble(<span class="stringliteral">"-rate"</span>, &amp;<a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a>) &amp;&amp; <a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a> != 0.0)
  {
    <span class="keywordflow">if</span>(<a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a> == -1)
      <a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a> = -1;
    <span class="keywordflow">else</span>
      <a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a> = <a name="a23"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArMath.html#5cc85672a327b96f1668aaf8efc58c7a">ArMath::roundInt</a>(1000.0 / <a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a>);
  }

  <a class="code" href="getVideoExample_8cpp.html#b2fdc0f1bbbd46b714580926f62fae6e">useCounter</a> = argParser.checkArgument(<span class="stringliteral">"-counter"</span>);

  <span class="keywordflow">if</span>(!<a name="a24"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#1b090c01d88bb420b8cf8e0384d25ee1">Aria::parseArgs</a>() || !argParser.checkHelpAndWarnUnparsed())
  {
    <a name="a25"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#10d71f3d4d0cf7f38c58a1f749f64a42">Aria::logOptions</a>();
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce3012daf6573594f91242f8dd7c02eb74b">ArLog::Terse</a>, <span class="stringliteral">"\n\n%s options:\n-rate &lt;FramesPerSecondAsDouble&gt; (If this isn't given, then the program will take one frame then exit, note that it is a double (so you can do .5 to do one frame per 2 seconds) and that if you set it to be too fast you'll saturate the robot's bandwidth and make it useless)\n-counter (default no)\n"</span>, argv[0]);

    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce3012daf6573594f91242f8dd7c02eb74b">ArLog::Terse</a>, <span class="stringliteral">"\n\nNotes:\nThis program saves the images as video.jpg if you aren't using a counter, or video&lt;counter&gt;.jpg if you are using the counter.\nIt puts its logs into getVideoLog.txt, and overwrites it whenever it runs\n"</span>);
    
    <span class="keywordflow">return</span> 1;
  }
  


  <a name="_a26"></a><a class="code" href="classArClientBase.html" title="The base client class.">ArClientBase</a> <a name="a27"></a><a class="code" href="configClient_8cpp.html#fe594bfb305907ae82f259409cc214cb">client</a>;
  <span class="keywordflow">if</span> (!clientConnector.connectClient(&amp;client))
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Could not connect to server, exiting\n"</span>);
    exit(1);
  }    

  <a name="_a28"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArGlobalFunctor1.html">ArGlobalFunctor1&lt;ArNetPacket *&gt;</a> jpegHandlerCB(&amp;<a class="code" href="getVideoExample_8cpp.html#b990e842f67b35df051fd7edddd35888">jpegHandler</a>);

  <span class="keywordflow">if</span>(client.<a name="a29"></a><a class="code" href="classArClientBase.html#873a731b968b4e3359c60d592122770b" title="Sees if this data exists.">dataExists</a>(<span class="stringliteral">"getPictureCam1"</span>))
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Requesting images using \"getPictureCam1\" request."</span>);
    client.<a name="a30"></a><a class="code" href="classArClientBase.html#57e195371c8ae810b4bbdd1020852aa5" title="Adds a functor for some particular data.">addHandler</a>(<span class="stringliteral">"getPictureCam1"</span>, &amp;jpegHandlerCB);
    <span class="keywordflow">if</span> (<a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a> != 0 &amp;&amp; <a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a> != 0)
      client.<a name="a31"></a><a class="code" href="classArClientBase.html#0a36a40fe2598eb214368ae8c3a26ca1" title="Request some data every mSec milliseconds.">request</a>(<span class="stringliteral">"getPictureCam1"</span>, <a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a>); 
    <span class="keywordflow">else</span>
      client.<a name="a32"></a><a class="code" href="classArClientBase.html#2dcd11daf8d2045d460b83733e6932d0" title="Request some data (or send a command) just once.">requestOnce</a>(<span class="stringliteral">"getPictureCam1"</span>);
  } 
  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(client.<a class="code" href="classArClientBase.html#873a731b968b4e3359c60d592122770b" title="Sees if this data exists.">dataExists</a>(<span class="stringliteral">"sendVideo"</span>))
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce37040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">"Server does not have \"getPictureCam1\" request, requesting images using old \"sendVideo\" request."</span>);
    client.<a class="code" href="classArClientBase.html#57e195371c8ae810b4bbdd1020852aa5" title="Adds a functor for some particular data.">addHandler</a>(<span class="stringliteral">"sendVideo"</span>, &amp;jpegHandlerCB);
    <span class="keywordflow">if</span> (<a class="code" href="getVideoExample_8cpp.html#40fc078492fcc08ce7ad3957496b4c0b">rate</a> != 0 &amp;&amp; <a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a> != 0)
      client.<a class="code" href="classArClientBase.html#0a36a40fe2598eb214368ae8c3a26ca1" title="Request some data every mSec milliseconds.">request</a>(<span class="stringliteral">"sendVideo"</span>, <a class="code" href="getVideoExample_8cpp.html#d9766129714f3e0c883bbb9879c85be4">rateAsTime</a>); 
    <span class="keywordflow">else</span>
      client.<a class="code" href="classArClientBase.html#2dcd11daf8d2045d460b83733e6932d0" title="Request some data (or send a command) just once.">requestOnce</a>(<span class="stringliteral">"sendVideo"</span>); 
  }
  <span class="keywordflow">else</span>
  {
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#43a8b3789126c818f390f24bdbceccce">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classArLog.html#c8cc0fb3aa323ab2a1c21340fdd1dce3012daf6573594f91242f8dd7c02eb74b">ArLog::Terse</a>, <span class="stringliteral">"Error: Server does not have \"getPictureCam1\" or \"sendVideo\" request, cannot request images."</span>);
    <a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#6abc3d39b3e9548063bb8e78375acc17">Aria::exit</a>(2);
  }


  client.<a name="a33"></a><a class="code" href="classArClientBase.html#012118e5e43ee6e75f9d56ad5fbf2b7b" title="Runs the client in this thread.">run</a>();

  <a name="a34"></a><a class="codeRef" doxygen="Aria.tag:../../docs/" href="../../docs/classAria.html#184602a2b3799d61569ec55dd9508450">Aria::shutdown</a>();
  <span class="keywordflow">return</span> 0;
}



</pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Aug 1 12:23:11 2012 for ArNetworking by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
